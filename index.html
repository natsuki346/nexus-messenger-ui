<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEXUS Chat UI Mock (HTML)</title>
  <style>
    :root{
      --bg:#000; --panel:#0b0b0b; --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12); --muted:rgba(255,255,255,.6);
      --text:#fff; --btn:rgba(255,255,255,.12);
      --chip:rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .avatar{width:40px;height:40px;border-radius:16px;background:rgba(255,255,255,.12)}
    .title{font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex;align-items:center;gap:10px}
    .pill{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:var(--card)}
    .pill label{font-size:13px;color:rgba(255,255,255,.85)}
    .select{background:var(--card);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:999px}
    .card{margin-top:14px;border:1px solid var(--line);border-radius:22px;background:var(--card);overflow:hidden;position:relative}
    .topPanel{
      position:absolute;left:0;right:0;top:0;z-index:10;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.7);backdrop-filter: blur(10px);
      display:none;
    }
    .topPanel.on{display:block}
    .topBar{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
    .topBar .left{display:flex;align-items:center;gap:10px;font-size:14px}
    .topBar .right{display:flex;align-items:center;gap:8px}
    .iconBtn{
      border:1px solid var(--line);background:var(--btn);color:var(--text);
      height:32px;min-width:32px;padding:0 10px;border-radius:14px;cursor:pointer
    }
    .topContent{padding:12px}
    .grid{display:grid;gap:12px}
    @media(min-width:820px){.grid.cols3{grid-template-columns:2fr 1fr}}
    .box{border:1px solid var(--line);background:var(--card);border-radius:22px;padding:14px;min-height:180px}
    .box h4{margin:0 0 6px 0;font-size:14px}
    .hint{font-size:12px;color:var(--muted);line-height:1.55}
    .chip{margin-top:10px;border:1px solid var(--line);background:var(--chip);border-radius:14px;padding:10px;font-size:12px;color:rgba(255,255,255,.75);line-height:1.55}
    .chatArea{height:70vh;display:flex;flex-direction:column}
    .messages{flex:1;overflow:auto;padding:14px}
    .msgRow{display:flex;margin-bottom:10px}
    .msgRow.me{justify-content:flex-end}
    .bubble{
      max-width:85%;border:1px solid var(--line);
      background:rgba(255,255,255,.09);border-radius:20px;
      padding:12px 12px 10px 12px;
    }
    .msgRow.them .bubble{background:rgba(255,255,255,.06)}
    .meta{display:flex;justify-content:space-between;gap:12px;font-size:11px;color:rgba(255,255,255,.55)}
    .text{margin-top:8px;font-size:14px}
    .translated{
      margin-top:8px;border:1px solid var(--line);background:var(--chip);
      border-radius:14px;padding:8px 10px;font-size:12px;color:rgba(255,255,255,.75)
    }
    .divider{height:1px;background:var(--line)}
    .composer{display:flex;gap:10px;padding:12px}
    .plus{width:42px;height:42px;border-radius:16px;border:1px solid var(--line);background:var(--btn);color:var(--text);font-size:18px;cursor:pointer}
    input[type="text"]{
      flex:1;height:42px;border-radius:18px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--text);padding:0 14px;outline:none
    }
    .send{height:42px;border-radius:18px;border:0;background:#fff;color:#000;padding:0 16px;cursor:pointer;font-weight:600}
    /* Modals */
    .modalBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:18px
    }
    .modalBackdrop.on{display:flex}
    .modal{
      width:min(560px,100%);border:1px solid var(--line);border-radius:22px;background:#000;color:#fff;
      padding:14px
    }
    .modalHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modalHeader h3{margin:0;font-size:16px}
    .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;background:rgba(255,255,255,.06);padding:6px;border-radius:18px;border:1px solid var(--line)}
    .tab{border:0;background:transparent;color:rgba(255,255,255,.8);padding:10px;border-radius:14px;cursor:pointer}
    .tab.active{background:rgba(255,255,255,.12);color:#fff}
    .actions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    @media(min-width:700px){.actions.two{grid-template-columns:1fr 1fr}}
    .actionBtn{
      display:flex;align-items:center;gap:10px;justify-content:flex-start;
      border:1px solid var(--line);background:rgba(255,255,255,.10);color:#fff;
      padding:12px;border-radius:18px;cursor:pointer
    }
    .rightRow{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
    .ghost{background:rgba(255,255,255,.10);border:1px solid var(--line);color:#fff;border-radius:18px;padding:10px 14px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="avatar"></div>
        <div>
          <div class="title">NEXUS Messenger</div>
          <div class="sub">HTML mock ‚Ä¢ split map/AI ‚Ä¢ auto-translate</div>
        </div>
      </div>

      <div class="controls">
        <div class="pill">
          <label>Auto translate</label>
          <input id="autoTranslate" type="checkbox" checked />
        </div>
        <select id="lang" class="select">
          <option>Japanese</option><option>English</option><option>Korean</option>
          <option>Chinese</option><option>Spanish</option><option>French</option>
        </select>
      </div>
    </div>

    <div class="card" id="card">
      <!-- Top split panel -->
      <div class="topPanel" id="topPanel">
        <div class="topBar">
          <div class="left"><span id="panelTitle">Panel</span></div>
          <div class="right">
            <button class="iconBtn" id="less">-</button>
            <button class="iconBtn" id="more">+</button>
            <button class="iconBtn" id="closePanel">‚úï</button>
          </div>
        </div>
        <div class="topContent" id="panelContent"></div>
      </div>

      <!-- Chat -->
      <div class="chatArea" id="chatArea">
        <div class="messages" id="messages"></div>
        <div class="divider"></div>
        <div class="composer">
          <button class="plus" id="openPlus">Ôºã</button>
          <input type="text" id="draft" placeholder="Message‚Ä¶" />
          <button class="send" id="send">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Plus Menu Modal -->
  <div class="modalBackdrop" id="plusModal">
    <div class="modal">
      <div class="modalHeader">
        <h3>Ôºã Menu</h3>
        <button class="iconBtn" id="closePlus">‚úï</button>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="attach">Attach</button>
        <button class="tab" data-tab="map">Map</button>
        <button class="tab" data-tab="pay">Pay</button>
      </div>

      <div id="tab_attach" class="actions two" style="margin-top:12px">
        <button class="actionBtn" id="pickImage">üñºÔ∏è Image / Video</button>
        <button class="actionBtn" id="pickFile">üìÑ File</button>
      </div>
      <div id="tab_map" class="actions" style="display:none;margin-top:12px">
        <button class="actionBtn" id="openMapSplit">üìç Open split map (no route change)</button>
        <div class="hint">Map opens as a reversible top panel with an explicit close button.</div>
      </div>
      <div id="tab_pay" class="actions" style="display:none;margin-top:12px">
        <button class="actionBtn" id="openPay">üí≥ Send money (in-chat modal)</button>
        <div class="hint">Pay must always be dismissible (Cancel / X / ESC).</div>
      </div>
    </div>
  </div>

  <!-- Pay Modal -->
  <div class="modalBackdrop" id="payModal">
    <div class="modal">
      <div class="modalHeader">
        <h3>NEXUS Pay</h3>
        <button class="iconBtn" id="closePay">‚úï</button>
      </div>
      <div class="box" style="min-height:auto">
        <div class="hint">Amount (JPY)</div>
        <input type="text" id="payAmount" value="1000" />
        <div class="hint" style="margin-top:8px">Confirm ‚Üí (biometric/auth later) ‚Üí send</div>
      </div>
      <div class="rightRow">
        <button class="ghost" id="cancelPay">Cancel</button>
        <button class="send" id="confirmPay">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Message Action Modal -->
  <div class="modalBackdrop" id="actionModal">
    <div class="modal">
      <div class="modalHeader">
        <h3>Message actions</h3>
        <button class="iconBtn" id="closeAction">‚úï</button>
      </div>
      <div class="box" style="min-height:auto">
        <div class="hint">Target</div>
        <div class="chip" id="targetText"></div>
      </div>
      <div class="actions two">
        <button class="actionBtn" data-ai="furigana">‚ú® Furigana</button>
        <button class="actionBtn" data-ai="meaning">‚ú® Meaning</button>
        <button class="actionBtn" data-ai="summary">‚ú® Summary</button>
        <button class="actionBtn" data-ai="translate">üåê Translate</button>
      </div>
      <div class="rightRow">
        <button class="ghost" id="closeAction2">Close</button>
      </div>
    </div>
  </div>

<script>
  // --- State ---
  let split = { kind: "none" }; // none | map | ai
  let splitRatio = 40; // top panel height in vh, clamp 30..70
  let selectedMessageId = null;

  const messages = [
    { id:"m1", sender:"them", text:"„Åì„Çå„ÄÅ„Å©„ÅÜÊÄù„ÅÜÔºü ÊúüÈôê„ÅåËø´„Å£„Å¶„Çã„ÄÇ", translated:"What do you think about this? The deadline is coming up.", time:"15:02" },
    { id:"m2", sender:"me", text:"‰∫ÜËß£„ÄÇ„Åæ„ÅöMVP„Å´Ââä„Å£„Å¶‰Ωú„Çã„ÄÇ", translated:"Got it. We'll cut it down to an MVP and build.", time:"15:04" },
    { id:"m3", sender:"them", text:"„ÄéÁüõÁõæ„Äè„Å£„Å¶Êº¢Â≠ó„ÅÆË™≠„ÅøÊñπ„Çè„Åã„ÇãÔºü", translated:"Do you know how to read the kanji for 'contradiction'?", time:"15:10" },
  ];

  const el = (id)=>document.getElementById(id);
  const autoTranslate = el("autoTranslate");
  const lang = el("lang");
  const topPanel = el("topPanel");
  const panelTitle = el("panelTitle");
  const panelContent = el("panelContent");
  const chatArea = el("chatArea");
  const messagesEl = el("messages");

  function clampRatio(v){ return Math.max(30, Math.min(70, v)); }

  function renderMessages(){
    messagesEl.innerHTML = "";
    const showTrans = autoTranslate.checked;
    messages.forEach(m=>{
      const row = document.createElement("div");
      row.className = "msgRow " + (m.sender==="me" ? "me":"them");

      const bub = document.createElement("div");
      bub.className = "bubble";
      bub.dataset.id = m.id;

      bub.innerHTML = `
        <div class="meta"><span>${m.time}</span><span>‚ãØ</span></div>
        <div class="text">${m.text}</div>
        ${showTrans && m.translated ? `<div class="translated">[${lang.value}] ${m.translated}</div>` : ``}
        <div style="margin-top:8px;font-size:11px;color:rgba(255,255,255,.4)">Tip: right-click (or long-press in app) for AI actions.</div>
      `;

      // Right-click to open action modal
      bub.addEventListener("contextmenu",(e)=>{
        e.preventDefault();
        selectedMessageId = m.id;
        el("targetText").textContent = m.text;
        openModal("actionModal");
      });

      row.appendChild(bub);
      messagesEl.appendChild(row);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function renderTopPanel(){
    if(split.kind==="none"){
      topPanel.classList.remove("on");
      chatArea.style.paddingTop = "0px";
      return;
    }
    topPanel.classList.add("on");
    const vh = clampRatio(splitRatio);
    topPanel.style.height = vh + "vh";
    chatArea.style.paddingTop = vh + "vh";

    if(split.kind==="map"){
      panelTitle.textContent = "üìç Map";
      panelContent.innerHTML = `
        <div class="grid cols3">
          <div class="box">
            <h4>Map placeholder</h4>
            <div class="hint">Replace with Mapbox/Google Maps. This is the real-time map area.</div>
            <div class="chip">
              ‚Ä¢ Split is state-based (no navigation)\n<br/>
              ‚Ä¢ Always closable via ‚úï\n<br/>
              ‚Ä¢ Send location stays in-chat
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:12px">
              <button class="ghost" id="sendLoc">üìç Send current location</button>
            </div>
          </div>
          <div class="box">
            <h4>Map tools</h4>
            <div class="chip">Distance: 1.4km<br/>ETA: 6 min<br/>Privacy: mutual follow only</div>
          </div>
        </div>
      `;
      setTimeout(()=>{ // bind after injection
        const b = el("sendLoc");
        if(b) b.onclick = ()=>{
          messages.push({ id:"m"+Date.now(), sender:"me", text:"ÁèæÂú®Âú∞„ÇíÈÄÅ„Å£„Åü", translated:"Sent my current location", time:new Date().toTimeString().slice(0,5) });
          renderMessages();
        };
      },0);
    }

    if(split.kind==="ai"){
      panelTitle.textContent = "‚ú® AI Assist";
      const m = messages.find(x=>x.id===split.messageId);
      const target = m ? m.text : "(no message)";
      panelContent.innerHTML = `
        <div class="grid cols3">
          <div class="box">
            <h4>Selected message</h4>
            <div class="chip">${escapeHtml(target)}</div>
            <div style="margin-top:10px" class="hint">Actions</div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px">
              <button class="ghost" data-run="furigana">Furigana</button>
              <button class="ghost" data-run="meaning">Meaning</button>
              <button class="ghost" data-run="summary">Summary</button>
              <button class="ghost" data-run="examples">Examples</button>
            </div>
          </div>
          <div class="box">
            <h4>Result ‚Ä¢ ${split.action}</h4>
            <div class="chip" style="height: calc(100% - 34px); overflow:auto">
              ${escapeHtml(mockAI(target, split.action)).replaceAll("\n","<br/>")}
            </div>
          </div>
        </div>
      `;
      setTimeout(()=>{
        panelContent.querySelectorAll("[data-run]").forEach(btn=>{
          btn.onclick = ()=> {
            split = { kind:"ai", messageId: split.messageId, action: btn.dataset.run };
            renderTopPanel();
          };
        });
      },0);
    }
  }

  function openSplitMap(){ split={kind:"map"}; renderTopPanel(); }
  function openSplitAI(messageId, action){ split={kind:"ai", messageId, action}; renderTopPanel(); }
  function closeSplit(){ split={kind:"none"}; renderTopPanel(); }

  // --- Modals ---
  function openModal(id){ el(id).classList.add("on"); }
  function closeModal(id){ el(id).classList.remove("on"); }

  // Plus menu tabs
  function setTab(name){
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
    ["attach","map","pay"].forEach(k=>{
      el("tab_"+k).style.display = (k===name) ? "grid" : "none";
    });
    if(name==="map") el("tab_map").style.display="block";
    if(name==="pay") el("tab_pay").style.display="block";
  }

  // --- Bindings ---
  el("openPlus").onclick = ()=> openModal("plusModal");
  el("closePlus").onclick = ()=> closeModal("plusModal");

  document.querySelectorAll(".tab").forEach(t=>{
    t.onclick = ()=> setTab(t.dataset.tab);
  });

  el("pickImage").onclick = ()=>{
    closeModal("plusModal");
    messages.push({ id:"m"+Date.now(), sender:"me", text:"ÁîªÂÉè„ÇíÈÄÅ„Å£„Åü", translated:"Sent an image", time:new Date().toTimeString().slice(0,5) });
    renderMessages();
  };
  el("pickFile").onclick = ()=>{
    closeModal("plusModal");
    messages.push({ id:"m"+Date.now(), sender:"me", text:"„Éï„Ç°„Ç§„É´„ÇíÈÄÅ„Å£„Åü", translated:"Sent a file", time:new Date().toTimeString().slice(0,5) });
    renderMessages();
  };
  el("openMapSplit").onclick = ()=>{
    closeModal("plusModal");
    openSplitMap();
  };
  el("openPay").onclick = ()=>{
    closeModal("plusModal");
    openModal("payModal");
  };

  el("closePay").onclick = ()=> closeModal("payModal");
  el("cancelPay").onclick = ()=> closeModal("payModal");
  el("confirmPay").onclick = ()=>{
    const amt = Math.max(0, Number(el("payAmount").value||0));
    if(!amt) return;
    closeModal("payModal");
    messages.push({ id:"m"+Date.now(), sender:"me", text:`¬•${amt.toLocaleString()} „ÇíÈÄÅÈáë„Åó„Åü`, translated:`Sent ¬•${amt.toLocaleString()}`, time:new Date().toTimeString().slice(0,5) });
    renderMessages();
  };
  // ESC closes modals & split (safety)
  window.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){
      ["plusModal","payModal","actionModal"].forEach(closeModal);
      closeSplit();
    }
  });

  el("closeAction").onclick = ()=> closeModal("actionModal");
  el("closeAction2").onclick = ()=> closeModal("actionModal");
  el("actionModal").addEventListener("click",(e)=>{
    if(e.target===el("actionModal")) closeModal("actionModal");
  });
  document.querySelectorAll("#actionModal [data-ai]").forEach(btn=>{
    btn.onclick = ()=>{
      closeModal("actionModal");
      if(!selectedMessageId) return;
      openSplitAI(selectedMessageId, btn.dataset.ai);
    };
  });

  // Top panel controls (guaranteed exit)
  el("closePanel").onclick = closeSplit;
  el("less").onclick = ()=>{ splitRatio = clampRatio(splitRatio - 10); renderTopPanel(); };
  el("more").onclick = ()=>{ splitRatio = clampRatio(splitRatio + 10); renderTopPanel(); };

  // Send
  el("send").onclick = ()=>{
    const t = el("draft").value.trim();
    if(!t) return;
    messages.push({ id:"m"+Date.now(), sender:"me", text:t, translated:`[${lang.value}] ${t}`, time:new Date().toTimeString().slice(0,5) });
    el("draft").value = "";
    renderMessages();
  };
  el("draft").addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){ e.preventDefault(); el("send").click(); }
  });

  autoTranslate.onchange = renderMessages;
  lang.onchange = renderMessages;

  function mockAI(text, action){
    if(action==="furigana") return `Reading assistance (mock)\n\n‚Ä¢ ÂØæË±°: ${text}\n‚Ä¢ ‰æã: ÁüõÁõæÔºà„ÇÄ„Åò„ÇÖ„ÇìÔºâ`;
    if(action==="meaning") return `Explanation (mock)\n\n‚Ä¢ ÂØæË±°: ${text}\n‚Ä¢ ÊñáËÑà„Å´Ê≤ø„Å£„Å¶Áü≠„ÅèËß£Ë™¨`;
    if(action==="summary") return `Summary (mock)\n\n‚Ä¢ ÂØæË±°: ${text}\n‚Ä¢ ‰∏ÄÊñá„Äú‰∏âÊñá„ÅßÂúßÁ∏Æ`;
    if(action==="translate") return `Translation (mock)\n\n‚Ä¢ ÂØæË±°: ${text}\n‚Ä¢ Ë®≠ÂÆöË®ÄË™û„Å∏ÁøªË®≥`;
    if(action==="examples") return `Examples (mock)\n\n‚Ä¢ ÂØæË±°: ${text}\n‚Ä¢ ‰æãÊñá„Çí2„Äú3ÂÄãÊèêÁ§∫`;
    return text;
  }
  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  // init
  renderMessages();
  renderTopPanel();
</script>
</body>
</html>
