import React, { useEffect, useMemo, useRef, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Switch } from "@/components/ui/switch";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Separator } from "@/components/ui/separator";
import {
  MapPin,
  Image as ImageIcon,
  FileText,
  CreditCard,
  Globe,
  Sparkles,
  Send,
  X,
  Maximize2,
  Minimize2,
  Pin,
  Search,
  Languages,
} from "lucide-react";

/**
 * NEXUS Chat Screen UI Spec
 * - Bottom input with left-side + menu for Attach / Map / Pay
 * - Top-right auto-translate toggle (language set elsewhere)
 * - Message long-press / right-click -> AI actions (furigana/meaning/summary/translate)
 * - Split panels for Map (top) and AI panel (top) that ALWAYS have a clear exit/close
 * - Pay runs in an in-chat modal, also always closable
 *
 * NOTE: This is UI-only (no backend). Wire up with your realtime + storage later.
 */

// -------------------- Types --------------------

type Message = {
  id: string;
  sender: "me" | "them";
  text?: string;
  translatedText?: string;
  createdAt: number;
  attachments?: { kind: "image" | "video" | "file"; name: string }[];
  location?: { label: string; lat: number; lng: number };
  payment?: { amountYen: number; status: "sent" | "requested" };
};

type SplitMode =
  | { kind: "none" }
  | { kind: "map" }
  | { kind: "ai"; messageId: string; action: AIAction };

type AIAction =
  | "furigana"
  | "meaning"
  | "summary"
  | "translate"
  | "examples";

// -------------------- Helpers --------------------

function uid(prefix = "id") {
  return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`;
}

function formatTime(ts: number) {
  const d = new Date(ts);
  const hh = d.getHours().toString().padStart(2, "0");
  const mm = d.getMinutes().toString().padStart(2, "0");
  return `${hh}:${mm}`;
}

// -------------------- Main Component --------------------

export default function NexusChatScreenUISpec() {
  // UI state
  const [autoTranslateOn, setAutoTranslateOn] = useState(true);
  const [translateTo, setTranslateTo] = useState("Japanese"); // settings page would control this

  // Split-pane state: ensures map/ai are reversible with explicit close.
  const [split, setSplit] = useState<SplitMode>({ kind: "none" });
  const [splitRatio, setSplitRatio] = useState(40); // top panel height percentage (30..70)

  // Pay modal state
  const [payOpen, setPayOpen] = useState(false);

  // Attach drawer state
  const [attachOpen, setAttachOpen] = useState(false);

  // Input state
  const [draft, setDraft] = useState("");

  // Message action menu
  const [activeMsgId, setActiveMsgId] = useState<string | null>(null);

  const scrollRef = useRef<HTMLDivElement | null>(null);

  const [messages, setMessages] = useState<Message[]>(() => {
    const now = Date.now();
    return [
      {
        id: uid("m"),
        sender: "them",
        text: "これ、どう思う？ 期限が迫ってる。",
        translatedText: "What do you think about this? The deadline is coming up.",
        createdAt: now - 1000 * 60 * 20,
      },
      {
        id: uid("m"),
        sender: "me",
        text: "了解。まずMVPに削って作る。",
        translatedText: "Got it. We'll cut it down to an MVP and build.",
        createdAt: now - 1000 * 60 * 18,
      },
      {
        id: uid("m"),
        sender: "them",
        text: "『矛盾』って漢字の読み方わかる？",
        translatedText: "Do you know how to read the kanji for 'contradiction'?",
        createdAt: now - 1000 * 60 * 12,
      },
    ];
  });

  // Auto-scroll on new messages
  useEffect(() => {
    const el = scrollRef.current;
    if (!el) return;
    el.scrollTop = el.scrollHeight;
  }, [messages.length]);

  const activeMsg = useMemo(
    () => messages.find((m) => m.id === activeMsgId) ?? null,
    [messages, activeMsgId]
  );

  const aiPanel = useMemo(() => {
    if (split.kind !== "ai") return null;
    const msg = messages.find((m) => m.id === split.messageId);
    if (!msg) return null;
    return {
      message: msg,
      action: split.action,
    };
  }, [split, messages]);

  // --------------- Actions ---------------

  function sendText() {
    const text = draft.trim();
    if (!text) return;
    const msg: Message = {
      id: uid("m"),
      sender: "me",
      text,
      translatedText: autoTranslateOn ? mockTranslate(text, translateTo) : undefined,
      createdAt: Date.now(),
    };
    setMessages((prev) => [...prev, msg]);
    setDraft("");
  }

  function openMapSplit() {
    setSplit({ kind: "map" });
  }

  function closeSplit() {
    setSplit({ kind: "none" });
  }

  function openAI(messageId: string, action: AIAction) {
    setSplit({ kind: "ai", messageId, action });
  }

  function sendLocation() {
    // Example message with location
    const msg: Message = {
      id: uid("m"),
      sender: "me",
      createdAt: Date.now(),
      location: { label: "Current location", lat: 35.6895, lng: 139.6917 },
      text: "現在地を送った",
      translatedText: autoTranslateOn ? "Sent my current location" : undefined,
    };
    setMessages((prev) => [...prev, msg]);
    // map split can remain open, but must be closable; keep as-is.
  }

  function requestPay() {
    setPayOpen(true);
  }

  function commitPay(amountYen: number) {
    const msg: Message = {
      id: uid("m"),
      sender: "me",
      createdAt: Date.now(),
      payment: { amountYen, status: "sent" },
      text: `¥${amountYen.toLocaleString()} を送金した`,
      translatedText: autoTranslateOn
        ? `Sent ¥${amountYen.toLocaleString()}`
        : undefined,
    };
    setMessages((prev) => [...prev, msg]);
    setPayOpen(false);
  }

  // --------------- Render ---------------

  return (
    <div className="min-h-[90vh] w-full bg-black text-white">
      <div className="mx-auto max-w-5xl p-4">
        <Header
          autoTranslateOn={autoTranslateOn}
          setAutoTranslateOn={setAutoTranslateOn}
          translateTo={translateTo}
          setTranslateTo={setTranslateTo}
        />

        <div className="mt-4 grid gap-3">
          {/* Main Chat Card */}
          <Card className="border-white/10 bg-white/5 shadow-xl">
            <CardContent className="p-0">
              {/* Split container */}
              <div className="relative">
                {/* Top split panel */}
                {split.kind !== "none" && (
                  <TopPanel
                    split={split}
                    ratio={splitRatio}
                    setRatio={setSplitRatio}
                    onClose={closeSplit}
                    onSendLocation={sendLocation}
                    aiPanel={aiPanel}
                    onRunAI={(action) => {
                      if (!aiPanel) return;
                      openAI(aiPanel.message.id, action);
                    }}
                  />
                )}

                {/* Chat area */}
                <div
                  className="flex flex-col"
                  style={{
                    height: "70vh",
                    paddingTop: split.kind === "none" ? 0 : `${splitRatio}vh`,
                  }}
                >
                  <ScrollArea className="flex-1">
                    <div
                      ref={scrollRef}
                      className="h-full max-h-[70vh] overflow-y-auto px-4 py-4"
                    >
                      <div className="space-y-3">
                        {messages.map((m) => (
                          <MessageBubble
                            key={m.id}
                            msg={m}
                            autoTranslateOn={autoTranslateOn}
                            onOpenActions={() => setActiveMsgId(m.id)}
                          />
                        ))}
                      </div>
                    </div>
                  </ScrollArea>

                  <Separator className="bg-white/10" />

                  {/* Composer */}
                  <Composer
                    draft={draft}
                    setDraft={setDraft}
                    onSend={sendText}
                    onOpenAttach={() => setAttachOpen(true)}
                  />
                </div>

                {/* Attach menu (in-chat) */}
                <AttachDrawer
                  open={attachOpen}
                  onOpenChange={setAttachOpen}
                  onPickImage={() => {
                    setAttachOpen(false);
                    // mock attachment
                    setMessages((prev) => [
                      ...prev,
                      {
                        id: uid("m"),
                        sender: "me",
                        createdAt: Date.now(),
                        attachments: [{ kind: "image", name: "photo.png" }],
                        text: "画像を送った",
                        translatedText: autoTranslateOn ? "Sent an image" : undefined,
                      },
                    ]);
                  }}
                  onPickFile={() => {
                    setAttachOpen(false);
                    setMessages((prev) => [
                      ...prev,
                      {
                        id: uid("m"),
                        sender: "me",
                        createdAt: Date.now(),
                        attachments: [{ kind: "file", name: "doc.pdf" }],
                        text: "ファイルを送った",
                        translatedText: autoTranslateOn ? "Sent a file" : undefined,
                      },
                    ]);
                  }}
                  onOpenMap={() => {
                    setAttachOpen(false);
                    openMapSplit();
                  }}
                  onOpenPay={() => {
                    setAttachOpen(false);
                    requestPay();
                  }}
                />

                {/* Pay modal */}
                <PayModal
                  open={payOpen}
                  onOpenChange={setPayOpen}
                  onConfirm={commitPay}
                />

                {/* Message actions menu (AI / translate / copy) */}
                <MessageActionMenu
                  open={!!activeMsgId}
                  onOpenChange={(v) => {
                    if (!v) setActiveMsgId(null);
                  }}
                  message={activeMsg}
                  onAction={(action) => {
                    if (!activeMsg) return;
                    setActiveMsgId(null);
                    openAI(activeMsg.id, action);
                  }}
                />
              </div>
            </CardContent>
          </Card>

          <FooterNotes />
        </div>
      </div>
    </div>
  );
}

// -------------------- Header --------------------

function Header({
  autoTranslateOn,
  setAutoTranslateOn,
  translateTo,
  setTranslateTo,
}: {
  autoTranslateOn: boolean;
  setAutoTranslateOn: (v: boolean) => void;
  translateTo: string;
  setTranslateTo: (v: string) => void;
}) {
  return (
    <div className="flex items-center justify-between gap-3">
      <div className="flex items-center gap-3">
        <div className="h-10 w-10 rounded-2xl bg-white/10" />
        <div>
          <div className="text-lg font-semibold">NEXUS Messenger</div>
          <div className="text-xs text-white/60">Chat UI spec • split map/AI • auto-translate</div>
        </div>
      </div>

      <div className="flex items-center gap-3">
        <div className="hidden items-center gap-2 md:flex">
          <div className="flex items-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-3 py-2">
            <Globe className="h-4 w-4 text-white/70" />
            <span className="text-sm text-white/80">Auto translate</span>
            <Switch checked={autoTranslateOn} onCheckedChange={setAutoTranslateOn} />
          </div>

          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="secondary" className="rounded-2xl bg-white/10 text-white hover:bg-white/15">
                <Languages className="mr-2 h-4 w-4" />
                {translateTo}
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent className="border-white/10 bg-black text-white">
              <DropdownMenuLabel>Translate to</DropdownMenuLabel>
              <DropdownMenuSeparator className="bg-white/10" />
              {[
                "Japanese",
                "English",
                "Korean",
                "Chinese",
                "Spanish",
                "French",
              ].map((lang) => (
                <DropdownMenuItem
                  key={lang}
                  className="focus:bg-white/10"
                  onClick={() => setTranslateTo(lang)}
                >
                  {lang}
                </DropdownMenuItem>
              ))}
            </DropdownMenuContent>
          </DropdownMenu>
        </div>

        {/* Mobile compact */}
        <div className="flex items-center gap-2 md:hidden">
          <Button
            variant="secondary"
            className="rounded-2xl bg-white/10 text-white hover:bg-white/15"
            onClick={() => setAutoTranslateOn(!autoTranslateOn)}
            aria-label="Toggle auto translate"
          >
            <Globe className="h-4 w-4" />
          </Button>
        </div>
      </div>
    </div>
  );
}

// -------------------- Top Panel (Map / AI) --------------------

function TopPanel({
  split,
  ratio,
  setRatio,
  onClose,
  onSendLocation,
  aiPanel,
  onRunAI,
}: {
  split: SplitMode;
  ratio: number;
  setRatio: (v: number) => void;
  onClose: () => void;
  onSendLocation: () => void;
  aiPanel: { message: Message; action: AIAction } | null;
  onRunAI: (action: AIAction) => void;
}) {
  // Clamp ratio 30..70
  const safeRatio = Math.max(30, Math.min(70, ratio));

  return (
    <div
      className="absolute left-0 right-0 top-0 z-10 overflow-hidden border-b border-white/10 bg-black/70 backdrop-blur"
      style={{ height: `${safeRatio}vh` }}
    >
      <div className="flex h-full flex-col">
        {/* Panel header with explicit exit */}
        <div className="flex items-center justify-between border-b border-white/10 px-3 py-2">
          <div className="flex items-center gap-2">
            {split.kind === "map" ? (
              <>
                <MapPin className="h-4 w-4 text-white/70" />
                <span className="text-sm text-white/90">Map</span>
              </>
            ) : (
              <>
                <Sparkles className="h-4 w-4 text-white/70" />
                <span className="text-sm text-white/90">AI Assist</span>
              </>
            )}
          </div>

          <div className="flex items-center gap-2">
            <Button
              variant="secondary"
              className="h-8 rounded-xl bg-white/10 px-2 text-white hover:bg-white/15"
              onClick={() => setRatio(Math.max(30, safeRatio - 10))}
              aria-label="Reduce panel height"
            >
              <Minimize2 className="h-4 w-4" />
            </Button>
            <Button
              variant="secondary"
              className="h-8 rounded-xl bg-white/10 px-2 text-white hover:bg-white/15"
              onClick={() => setRatio(Math.min(70, safeRatio + 10))}
              aria-label="Increase panel height"
            >
              <Maximize2 className="h-4 w-4" />
            </Button>
            <Button
              variant="secondary"
              className="h-8 rounded-xl bg-white/10 px-2 text-white hover:bg-white/15"
              onClick={onClose}
              aria-label="Close panel"
            >
              <X className="h-4 w-4" />
            </Button>
          </div>
        </div>

        {/* Panel content */}
        <div className="flex-1 p-3">
          {split.kind === "map" ? (
            <MapPanel onSendLocation={onSendLocation} />
          ) : (
            <AIPanel aiPanel={aiPanel} onRunAI={onRunAI} />
          )}
        </div>
      </div>
    </div>
  );
}

function MapPanel({ onSendLocation }: { onSendLocation: () => void }) {
  return (
    <div className="grid h-full grid-cols-1 gap-3 md:grid-cols-3">
      <div className="md:col-span-2">
        <div className="h-full min-h-[200px] rounded-2xl border border-white/10 bg-white/5 p-4">
          <div className="flex h-full flex-col justify-between">
            <div>
              <div className="text-sm font-medium">Map placeholder</div>
              <div className="mt-1 text-xs text-white/60">
                Replace with Google Maps / Mapbox. This area is the real-time map.
              </div>
              <div className="mt-3 rounded-xl border border-white/10 bg-black/30 p-3 text-xs text-white/70">
                • When split is open, user must ALWAYS be able to close (X)
                <br />• Map interactions should never hijack navigation
                <br />• Send location uses in-chat message (no route change)
              </div>
            </div>
            <div className="flex items-center justify-end gap-2">
              <Button
                variant="secondary"
                className="rounded-2xl bg-white/10 text-white hover:bg-white/15"
                onClick={onSendLocation}
              >
                <MapPin className="mr-2 h-4 w-4" />
                Send current location
              </Button>
            </div>
          </div>
        </div>
      </div>
      <div className="md:col-span-1">
        <div className="h-full rounded-2xl border border-white/10 bg-white/5 p-4">
          <div className="text-sm font-medium">Map tools</div>
          <div className="mt-2 space-y-2 text-xs text-white/70">
            <div className="rounded-xl border border-white/10 bg-black/30 p-3">
              • Distance / ETA (mock)
              <div className="mt-2 text-white/60">Distance: 1.4km</div>
              <div className="text-white/60">ETA: 6 min</div>
            </div>
            <div className="rounded-xl border border-white/10 bg-black/30 p-3">
              • Visibility: mutual follow only
              <div className="mt-2 text-white/60">Privacy: ON</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function AIPanel({
  aiPanel,
  onRunAI,
}: {
  aiPanel: { message: Message; action: AIAction } | null;
  onRunAI: (action: AIAction) => void;
}) {
  if (!aiPanel) {
    return (
      <div className="flex h-full items-center justify-center rounded-2xl border border-white/10 bg-white/5 p-6 text-center">
        <div>
          <div className="text-sm font-medium">Select a message → AI Assist</div>
          <div className="mt-2 text-xs text-white/60">
            Long-press / right-click a message and choose Furigana / Meaning / Summary.
          </div>
        </div>
      </div>
    );
  }

  const { message, action } = aiPanel;
  return (
    <div className="grid h-full grid-cols-1 gap-3 md:grid-cols-3">
      <div className="md:col-span-1">
        <div className="h-full rounded-2xl border border-white/10 bg-white/5 p-4">
          <div className="text-xs text-white/60">Selected message</div>
          <div className="mt-2 rounded-xl border border-white/10 bg-black/30 p-3 text-sm">
            {message.text ?? "(non-text message)"}
          </div>

          <div className="mt-4">
            <div className="text-xs text-white/60">Actions</div>
            <div className="mt-2 grid grid-cols-2 gap-2">
              <Button
                variant="secondary"
                className="rounded-xl bg-white/10 text-white hover:bg-white/15"
                onClick={() => onRunAI("furigana")}
              >
                Furigana
              </Button>
              <Button
                variant="secondary"
                className="rounded-xl bg-white/10 text-white hover:bg-white/15"
                onClick={() => onRunAI("meaning")}
              >
                Meaning
              </Button>
              <Button
                variant="secondary"
                className="rounded-xl bg-white/10 text-white hover:bg-white/15"
                onClick={() => onRunAI("summary")}
              >
                Summary
              </Button>
              <Button
                variant="secondary"
                className="rounded-xl bg-white/10 text-white hover:bg-white/15"
                onClick={() => onRunAI("examples")}
              >
                Examples
              </Button>
            </div>
          </div>
        </div>
      </div>

      <div className="md:col-span-2">
        <div className="h-full rounded-2xl border border-white/10 bg-white/5 p-4">
          <div className="flex items-center justify-between">
            <div className="text-sm font-medium">Result • {labelForAIAction(action)}</div>
            <div className="text-xs text-white/60">(mock output)</div>
          </div>
          <div className="mt-3 h-[calc(100%-40px)] overflow-auto rounded-xl border border-white/10 bg-black/30 p-4 text-sm leading-relaxed">
            {mockAIOutput(message.text ?? "", action)}
          </div>
        </div>
      </div>
    </div>
  );
}

function labelForAIAction(a: AIAction) {
  switch (a) {
    case "furigana":
      return "Reading";
    case "meaning":
      return "Explanation";
    case "summary":
      return "Summary";
    case "translate":
      return "Translation";
    case "examples":
      return "Examples";
    default:
      return "AI";
  }
}

// -------------------- Message Bubble --------------------

function MessageBubble({
  msg,
  autoTranslateOn,
  onOpenActions,
}: {
  msg: Message;
  autoTranslateOn: boolean;
  onOpenActions: () => void;
}) {
  const mine = msg.sender === "me";

  return (
    <div className={`flex ${mine ? "justify-end" : "justify-start"}`}>
      <div
        className={
          `max-w-[85%] rounded-2xl border px-4 py-3 ` +
          (mine
            ? "border-white/10 bg-white/10"
            : "border-white/10 bg-white/5")
        }
        onContextMenu={(e) => {
          e.preventDefault();
          onOpenActions();
        }}
        onDoubleClick={onOpenActions}
        role="button"
        tabIndex={0}
        aria-label="Message"
      >
        <div className="flex items-center justify-between gap-4">
          <div className="text-xs text-white/60">{formatTime(msg.createdAt)}</div>
          <div className="flex items-center gap-2 text-white/40">
            <Pin className="h-3.5 w-3.5" />
            <Search className="h-3.5 w-3.5" />
          </div>
        </div>

        {msg.text && <div className="mt-2 text-sm">{msg.text}</div>}

        {/* Auto translation line */}
        {autoTranslateOn && msg.translatedText && (
          <div className="mt-2 rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-xs text-white/70">
            {msg.translatedText}
          </div>
        )}

        {/* Attachments */}
        {msg.attachments?.length ? (
          <div className="mt-3 space-y-2">
            {msg.attachments.map((a, idx) => (
              <div
                key={`${a.kind}_${idx}`}
                className="flex items-center gap-2 rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-xs"
              >
                {a.kind === "image" ? (
                  <ImageIcon className="h-4 w-4 text-white/70" />
                ) : a.kind === "video" ? (
                  <ImageIcon className="h-4 w-4 text-white/70" />
                ) : (
                  <FileText className="h-4 w-4 text-white/70" />
                )}
                <span className="text-white/80">{a.name}</span>
              </div>
            ))}
          </div>
        ) : null}

        {/* Location */}
        {msg.location ? (
          <div className="mt-3 rounded-xl border border-white/10 bg-black/30 p-3 text-xs">
            <div className="flex items-center gap-2">
              <MapPin className="h-4 w-4 text-white/70" />
              <span className="text-white/80">{msg.location.label}</span>
            </div>
            <div className="mt-1 text-white/60">
              {msg.location.lat.toFixed(4)}, {msg.location.lng.toFixed(4)}
            </div>
          </div>
        ) : null}

        {/* Payment */}
        {msg.payment ? (
          <div className="mt-3 rounded-xl border border-white/10 bg-black/30 p-3 text-xs">
            <div className="flex items-center gap-2">
              <CreditCard className="h-4 w-4 text-white/70" />
              <span className="text-white/80">
                {msg.payment.status === "sent" ? "Payment sent" : "Payment requested"}
              </span>
            </div>
            <div className="mt-1 text-white/60">¥{msg.payment.amountYen.toLocaleString()}</div>
          </div>
        ) : null}

        <div className="mt-3 text-[11px] text-white/40">
          Tip: right-click / double-click to open AI actions.
        </div>
      </div>
    </div>
  );
}

// -------------------- Composer --------------------

function Composer({
  draft,
  setDraft,
  onSend,
  onOpenAttach,
}: {
  draft: string;
  setDraft: (v: string) => void;
  onSend: () => void;
  onOpenAttach: () => void;
}) {
  return (
    <div className="flex items-center gap-2 px-3 py-3">
      <Button
        variant="secondary"
        className="h-10 w-10 rounded-2xl bg-white/10 p-0 text-white hover:bg-white/15"
        onClick={onOpenAttach}
        aria-label="Open plus menu"
      >
        <span className="text-lg leading-none">＋</span>
      </Button>

      <Input
        value={draft}
        onChange={(e) => setDraft(e.target.value)}
        placeholder="Message…"
        className="h-10 rounded-2xl border-white/10 bg-white/5 text-white placeholder:text-white/40"
        onKeyDown={(e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            onSend();
          }
        }}
      />

      <Button
        className="h-10 rounded-2xl bg-white text-black hover:bg-white/90"
        onClick={onSend}
        aria-label="Send"
      >
        <Send className="mr-2 h-4 w-4" />
        Send
      </Button>
    </div>
  );
}

// -------------------- Attach Drawer --------------------

function AttachDrawer({
  open,
  onOpenChange,
  onPickImage,
  onPickFile,
  onOpenMap,
  onOpenPay,
}: {
  open: boolean;
  onOpenChange: (v: boolean) => void;
  onPickImage: () => void;
  onPickFile: () => void;
  onOpenMap: () => void;
  onOpenPay: () => void;
}) {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="border-white/10 bg-black text-white sm:max-w-[520px]">
        <DialogHeader>
          <DialogTitle className="text-white">＋ Menu</DialogTitle>
        </DialogHeader>

        <Tabs defaultValue="attach" className="w-full">
          <TabsList className="grid w-full grid-cols-3 rounded-2xl bg-white/5">
            <TabsTrigger value="attach" className="rounded-2xl">Attach</TabsTrigger>
            <TabsTrigger value="map" className="rounded-2xl">Map</TabsTrigger>
            <TabsTrigger value="pay" className="rounded-2xl">Pay</TabsTrigger>
          </TabsList>

          <TabsContent value="attach" className="mt-4">
            <div className="grid grid-cols-1 gap-2 md:grid-cols-2">
              <Button
                variant="secondary"
                className="justify-start rounded-2xl bg-white/10 text-white hover:bg-white/15"
                onClick={onPickImage}
              >
                <ImageIcon className="mr-2 h-4 w-4" />
                Image / Video
              </Button>
              <Button
                variant="secondary"
                className="justify-start rounded-2xl bg-white/10 text-white hover:bg-white/15"
                onClick={onPickFile}
              >
                <FileText className="mr-2 h-4 w-4" />
                File
              </Button>
            </div>
          </TabsContent>

          <TabsContent value="map" className="mt-4">
            <Button
              variant="secondary"
              className="w-full justify-start rounded-2xl bg-white/10 text-white hover:bg-white/15"
              onClick={onOpenMap}
            >
              <MapPin className="mr-2 h-4 w-4" />
              Open split map (no route change)
            </Button>
            <div className="mt-2 text-xs text-white/60">
              Map opens as a reversible top panel with an explicit close button.
            </div>
          </TabsContent>

          <TabsContent value="pay" className="mt-4">
            <Button
              variant="secondary"
              className="w-full justify-start rounded-2xl bg-white/10 text-white hover:bg-white/15"
              onClick={onOpenPay}
            >
              <CreditCard className="mr-2 h-4 w-4" />
              Send money (in-chat modal)
            </Button>
            <div className="mt-2 text-xs text-white/60">
              Pay must always be dismissible (X / cancel / ESC).
            </div>
          </TabsContent>
        </Tabs>
      </DialogContent>
    </Dialog>
  );
}

// -------------------- Pay Modal --------------------

function PayModal({
  open,
  onOpenChange,
  onConfirm,
}: {
  open: boolean;
  onOpenChange: (v: boolean) => void;
  onConfirm: (amountYen: number) => void;
}) {
  const [amount, setAmount] = useState("1000");

  useEffect(() => {
    if (!open) return;
    setAmount("1000");
  }, [open]);

  const amountNum = Math.max(0, Number(amount || 0));

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="border-white/10 bg-black text-white sm:max-w-[520px]">
        <DialogHeader>
          <DialogTitle className="text-white">NEXUS Pay</DialogTitle>
        </DialogHeader>

        <div className="space-y-3">
          <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div className="text-xs text-white/60">Amount (JPY)</div>
            <Input
              value={amount}
              onChange={(e) => setAmount(e.target.value.replace(/[^0-9]/g, ""))}
              className="mt-2 h-10 rounded-2xl border-white/10 bg-black/30 text-white"
              inputMode="numeric"
            />
            <div className="mt-2 text-xs text-white/60">
              Confirm → (biometric/auth step later) → send
            </div>
          </div>

          <div className="flex items-center justify-end gap-2">
            <Button
              variant="secondary"
              className="rounded-2xl bg-white/10 text-white hover:bg-white/15"
              onClick={() => onOpenChange(false)}
            >
              Cancel
            </Button>
            <Button
              className="rounded-2xl bg-white text-black hover:bg-white/90"
              onClick={() => onConfirm(amountNum)}
              disabled={!Number.isFinite(amountNum) || amountNum <= 0}
            >
              Confirm
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}

// -------------------- Message Action Menu --------------------

function MessageActionMenu({
  open,
  onOpenChange,
  message,
  onAction,
}: {
  open: boolean;
  onOpenChange: (v: boolean) => void;
  message: Message | null;
  onAction: (action: AIAction) => void;
}) {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="border-white/10 bg-black text-white sm:max-w-[520px]">
        <DialogHeader>
          <DialogTitle className="text-white">Message actions</DialogTitle>
        </DialogHeader>

        <div className="space-y-3">
          <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div className="text-xs text-white/60">Target</div>
            <div className="mt-2 rounded-xl border border-white/10 bg-black/30 p-3 text-sm">
              {message?.text ?? "(no message)"}
            </div>
          </div>

          <div className="grid grid-cols-2 gap-2">
            <Button
              variant="secondary"
              className="justify-start rounded-2xl bg-white/10 text-white hover:bg-white/15"
              onClick={() => onAction("furigana")}
              disabled={!message?.text}
            >
              <Sparkles className="mr-2 h-4 w-4" />
              Furigana
            </Button>
            <Button
              variant="secondary"
              className="justify-start rounded-2xl bg-white/10 text-white hover:bg-white/15"
              onClick={() => onAction("meaning")}
              disabled={!message?.text}
            >
              <Sparkles className="mr-2 h-4 w-4" />
              Meaning
            </Button>
            <Button
              variant="secondary"
              className="justify-start rounded-2xl bg-white/10 text-white hover:bg-white/15"
              onClick={() => onAction("summary")}
              disabled={!message?.text}
            >
              <Sparkles className="mr-2 h-4 w-4" />
              Summary
            </Button>
            <Button
              variant="secondary"
              className="justify-start rounded-2xl bg-white/10 text-white hover:bg-white/15"
              onClick={() => onAction("translate")}
              disabled={!message?.text}
            >
              <Globe className="mr-2 h-4 w-4" />
              Translate
            </Button>
          </div>

          <div className="flex items-center justify-end gap-2">
            <Button
              variant="secondary"
              className="rounded-2xl bg-white/10 text-white hover:bg-white/15"
              onClick={() => onOpenChange(false)}
            >
              Close
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}

// -------------------- Footer Notes --------------------

function FooterNotes() {
  return (
    <div className="rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-white/70">
      <div className="font-medium text-white">UI guarantees (important)</div>
      <ul className="mt-2 list-disc space-y-1 pl-5">
        <li>
          Map split & AI split are <span className="text-white">state-based panels</span> (no navigation) and have an explicit <span className="text-white">X</span> to close.
        </li>
        <li>
          Pay is a modal that is always dismissible (Cancel / X / ESC).
        </li>
        <li>
          Auto-translate is a toggle; translated text is shown as a secondary line and can be cached.
        </li>
        <li>
          Message actions are opened via right-click/double-click here; on mobile, wire to long-press.
        </li>
      </ul>
    </div>
  );
}

// -------------------- Mock translation / AI --------------------

function mockTranslate(text: string, to: string) {
  // Placeholder for real translation API.
  return `[${to}] ${text}`;
}

function mockAIOutput(text: string, action: AIAction) {
  const base = text || "(empty)";
  switch (action) {
    case "furigana":
      return `Reading assistance (mock)\n\n• 対象: ${base}\n• 例: 矛盾（むじゅん）\n\n実装: 選択テキスト→AI/辞書API→ふりがな付与→結果表示`;
    case "meaning":
      return `Explanation (mock)\n\n• 対象: ${base}\n• 解説: 文脈に沿って意味を短く説明\n\n実装: 選択テキスト＋周辺メッセージ→LLM→要点抽出`;
    case "summary":
      return `Summary (mock)\n\n• 対象: ${base}\n• 要約: 一文〜三文で圧縮\n\n実装: メッセージ単体 or スレッド範囲→LLM→短要約`;
    case "translate":
      return `Translation (mock)\n\n• 対象: ${base}\n• 翻訳: 設定言語へ変換\n\n実装: 翻訳API→DBキャッシュ→表示`;
    case "examples":
      return `Examples (mock)\n\n• 対象: ${base}\n• 例文: 使い方を2〜3個提示\n\n実装: LLMで例文生成（安全フィルタ）`;
    default:
      return base;
  }
}
